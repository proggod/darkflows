import mysql from 'mysql2/promise';

export default async function LeasesPage() {
  let connection;
  let leases = [];
  try {
    connection = await mysql.createConnection({
      socketPath: process.env.DATABASE_SOCKET,
      user: process.env.DATABASE_USER,
      password: process.env.DATABASE_PASSWORD,
      database: process.env.DATABASE_NAME
    });
    const [rows] = await connection.execute(
      `
      SELECT 
        INET_NTOA(l4.address) AS ip_address, 
        HEX(l4.hwaddr) AS mac_address, 
        l4.hostname AS device_name, 
        l4.expire, 
        ls.name AS state_name 
      FROM 
        lease4 l4 
      JOIN 
        lease_state ls ON l4.state = ls.state 
      WHERE 
        l4.expire > NOW() OR l4.expire IS NULL 
      ORDER BY 
        l4.expire;
      `
    );
    leases = rows.map(row => ({
      ip_address: row.ip_address,
      mac_address: row.mac_address,
      device_name: row.device_name || 'N/A',
      expire: row.expire ? new Date(row.expire) : null,
      state_name: row.state_name
    }));
  } catch (error) {
    console.error('Error fetching leases:', error);
  } finally {
    if (connection && connection.end) {
      await connection.end();
    }
  }
  
  return (
    <div className="min-h-screen bg-white flex flex-col font-sans">
      <div className="flex-grow px-4 sm:px-6 lg:px-8 py-6 max-w-7xl mx-auto w-full">
        <h1 className="text-2xl font-bold mb-8 text-center text-foreground">Active DHCP Leases</h1>
        <div className="overflow-x-auto shadow-sm rounded-lg">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-4 py-3 text-left text-sm font-medium text-gray-700 uppercase tracking-wider">IP Address</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-gray-700 uppercase tracking-wider">MAC Address</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-gray-700 uppercase tracking-wider">Device Name</th>
                <th className="sm:table-cell hidden px-4 py-3 text-left text-sm font-medium text-gray-700 uppercase tracking-wider">
                  Expires
                </th>
                <th className="sm:table-cell hidden px-4 py-3 text-left text-sm font-medium text-gray-700 uppercase tracking-wider">
                  Status
                </th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {leases.map((lease) => (
                <tr key={lease.ip_address} className="hover:bg-gray-50">
                  <td className="px-4 py-4 whitespace-nowrap text-sm text-gray-700">{lease.ip_address}</td>
                  <td className="px-4 py-4 whitespace-nowrap text-sm text-gray-700">{lease.mac_address}</td>
                  <td className="px-4 py-4 whitespace-nowrap text-sm text-gray-700">{lease.device_name}</td>
                  <td className="sm:table-cell hidden px-4 py-4 whitespace-nowrap text-sm text-gray-700">
                    {lease.expire ? lease.expire.toLocaleString() : 'No expiration'}
                  </td>
                  <td className="sm:table-cell hidden px-4 py-4 whitespace-nowrap text-sm text-gray-700">
                    {lease.state_name}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}

